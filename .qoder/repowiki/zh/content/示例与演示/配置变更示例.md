# 配置变更示例

<cite>
**本文档引用文件**   
- [ChangeTo123Client.java](file://demos/src/main/java/com/github/dtprj/dongting/demos/configchange/ChangeTo123Client.java)
- [ChangeTo234Client.java](file://demos/src/main/java/com/github/dtprj/dongting/demos/configchange/ChangeTo234Client.java)
- [ConfigChangeDemoServer1.java](file://demos/src/main/java/com/github/dtprj/dongting/demos/configchange/ConfigChangeDemoServer1.java)
- [ConfigChangeDemoServer2.java](file://demos/src/main/java/com/github/dtprj/dongting/demos/configchange/ConfigChangeDemoServer2.java)
- [ConfigChangeDemoServer3.java](file://demos/src/main/java/com/github/dtprj/dongting/demos/configchange/ConfigChangeDemoServer3.java)
- [ConfigChangeDemoServer4.java](file://demos/src/main/java/com/github/dtprj/dongting/demos/configchange/ConfigChangeDemoServer4.java)
- [GroupId.java](file://demos/src/main/java/com/github/dtprj/dongting/demos/configchange/GroupId.java)
- [AdminRaftClient.java](file://server/src/main/java/com/github/dtprj/dongting/raft/admin/AdminRaftClient.java)
- [AdminConfigChangeProcessor.java](file://server/src/main/java/com/github/dtprj/dongting/raft/rpc/AdminConfigChangeProcessor.java)
- [RaftGroup.java](file://server/src/main/java/com/github/dtprj/dongting/raft/server/RaftGroup.java)
- [RaftGroupImpl.java](file://server/src/main/java/com/github/dtprj/dongting/raft/impl/RaftGroupImpl.java)
- [MemberManager.java](file://server/src/main/java/com/github/dtprj/dongting/raft/impl/MemberManager.java)
- [ConfigChangeTest.java](file://server/src/test/java/com/github/dtprj/dongting/raft/server/ConfigChangeTest.java)
</cite>

## 目录
1. [引言](#引言)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构概述](#架构概述)
5. [详细组件分析](#详细组件分析)
6. [依赖分析](#依赖分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)

## 引言
本文档深入解析动态配置变更示例，说明如何通过ChangeTo123Client和ChangeTo234Client实现集群成员的在线增删，展示从三节点到四节点再回退的完整配置演进过程。解释每个ConfigChangeDemoServer的启动顺序和角色转换机制。提供配置变更过程中的状态监控方法和一致性验证手段。通过此示例帮助用户理解RAFT算法中成员变更的复杂性及其实现细节。

## 项目结构
配置变更示例位于demos模块的configchange包中，包含四个服务器实现和两个客户端实现。服务器实现分别对应四个不同的节点，客户端实现用于执行配置变更操作。

```mermaid
graph TD
subgraph "配置变更示例"
subgraph "服务器"
S1[ConfigChangeDemoServer1]
S2[ConfigChangeDemoServer2]
S3[ConfigChangeDemoServer3]
S4[ConfigChangeDemoServer4]
end
subgraph "客户端"
C1[ChangeTo123Client]
C2[ChangeTo234Client]
end
C1 --> S1
C1 --> S2
C1 --> S3
C1 --> S4
C2 --> S1
C2 --> S2
C2 --> S3
C2 --> S4
end
```

**图示来源**
- [ConfigChangeDemoServer1.java](file://demos/src/main/java/com/github/dtprj/dongting/demos/configchange/ConfigChangeDemoServer1.java)
- [ConfigChangeDemoServer2.java](file://demos/src/main/java/com/github/dtprj/dongting/demos/configchange/ConfigChangeDemoServer2.java)
- [ConfigChangeDemoServer3.java](file://demos/src/main/java/com/github/dtprj/dongting/demos/configchange/ConfigChangeDemoServer3.java)
- [ConfigChangeDemoServer4.java](file://demos/src/main/java/com/github/dtprj/dongting/demos/configchange/ConfigChangeDemoServer4.java)
- [ChangeTo123Client.java](file://demos/src/main/java/com/github/dtprj/dongting/demos/configchange/ChangeTo123Client.java)
- [ChangeTo234Client.java](file://demos/src/main/java/com/github/dtprj/dongting/demos/configchange/ChangeTo234Client.java)

**章节来源**
- [ConfigChangeDemoServer1.java](file://demos/src/main/java/com/github/dtprj/dongting/demos/configchange/ConfigChangeDemoServer1.java)
- [ConfigChangeDemoServer2.java](file://demos/src/main/java/com/github/dtprj/dongting/demos/configchange/ConfigChangeDemoServer2.java)
- [ConfigChangeDemoServer3.java](file://demos/src/main/java/com/github/dtprj/dongting/demos/configchange/ConfigChangeDemoServer3.java)
- [ConfigChangeDemoServer4.java](file://demos/src/main/java/com/github/dtprj/dongting/demos/configchange/ConfigChangeDemoServer4.java)
- [ChangeTo123Client.java](file://demos/src/main/java/com/github/dtprj/dongting/demos/configchange/ChangeTo123Client.java)
- [ChangeTo234Client.java](file://demos/src/main/java/com/github/dtprj/dongting/demos/configchange/ChangeTo234Client.java)

## 核心组件
配置变更示例的核心组件包括四个服务器节点和两个客户端。服务器节点实现了基于RAFT算法的分布式一致性，客户端用于执行配置变更操作。每个服务器节点都有唯一的节点ID和监听端口，通过预定义的服务器列表进行通信。

**章节来源**
- [ConfigChangeDemoServer1.java](file://demos/src/main/java/com/github/dtprj/dongting/demos/configchange/ConfigChangeDemoServer1.java)
- [ConfigChangeDemoServer2.java](file://demos/src/main/java/com/github/dtprj/dongting/demos/configchange/ConfigChangeDemoServer2.java)
- [ConfigChangeDemoServer3.java](file://demos/src/main/java/com/github/dtprj/dongting/demos/configchange/ConfigChangeDemoServer3.java)
- [ConfigChangeDemoServer4.java](file://demos/src/main/java/com/github/dtprj/dongting/demos/configchange/ConfigChangeDemoServer4.java)
- [ChangeTo123Client.java](file://demos/src/main/java/com/github/dtprj/dongting/demos/configchange/ChangeTo123Client.java)
- [ChangeTo234Client.java](file://demos/src/main/java/com/github/dtprj/dongting/demos/configchange/ChangeTo234Client.java)

## 架构概述
配置变更示例采用RAFT算法实现分布式一致性，通过两阶段提交协议（Joint Consensus）实现安全的成员变更。架构包括四个服务器节点和一个管理客户端，客户端通过AdminRaftClient与服务器集群通信，执行配置变更操作。

```mermaid
graph TD
subgraph "客户端"
Client[ChangeTo123Client/ChangeTo234Client]
end
subgraph "服务器集群"
S1[ConfigChangeDemoServer1]
S2[ConfigChangeDemoServer2]
S3[ConfigChangeDemoServer3]
S4[ConfigChangeDemoServer4]
end
Client --> |prepareConfigChange| S2
S2 --> |广播| S1
S2 --> |广播| S3
S2 --> |广播| S4
S1 --> |投票| S2
S3 --> |投票| S2
S4 --> |投票| S2
S2 --> |commitChange| S1
S2 --> |commitChange| S3
S2 --> |commitChange| S4
style Client fill:#f9f,stroke:#333
style S1 fill:#bbf,stroke:#333
style S2 fill:#bbf,stroke:#333
style S3 fill:#bbf,stroke:#333
style S4 fill:#bbf,stroke:#333
```

**图示来源**
- [AdminRaftClient.java](file://server/src/main/java/com/github/dtprj/dongting/raft/admin/AdminRaftClient.java)
- [AdminConfigChangeProcessor.java](file://server/src/main/java/com/github/dtprj/dongting/raft/rpc/AdminConfigChangeProcessor.java)
- [RaftGroupImpl.java](file://server/src/main/java/com/github/dtprj/dongting/raft/impl/RaftGroupImpl.java)

## 详细组件分析

### 服务器节点分析
配置变更示例包含四个服务器节点，分别对应节点ID 1、2、3、4。每个节点通过main方法启动，配置了相同的服务器列表，但初始成员配置不同。节点1、2、3初始成员为[1,2,3]，节点4初始成员为[2,3,4]。

```mermaid
classDiagram
class ConfigChangeDemoServer1 {
+main(String[] args)
}
class ConfigChangeDemoServer2 {
+main(String[] args)
}
class ConfigChangeDemoServer3 {
+main(String[] args)
}
class ConfigChangeDemoServer4 {
+main(String[] args)
}
class DemoKvServerBase {
+startServer(int nodeId, String servers, String members, String observers, int[] groupIds)
}
ConfigChangeDemoServer1 --> DemoKvServerBase : "继承"
ConfigChangeDemoServer2 --> DemoKvServerBase : "继承"
ConfigChangeDemoServer3 --> DemoKvServerBase : "继承"
ConfigChangeDemoServer4 --> DemoKvServerBase : "继承"
```

**图示来源**
- [ConfigChangeDemoServer1.java](file://demos/src/main/java/com/github/dtprj/dongting/demos/configchange/ConfigChangeDemoServer1.java)
- [ConfigChangeDemoServer2.java](file://demos/src/main/java/com/github/dtprj/dongting/demos/configchange/ConfigChangeDemoServer2.java)
- [ConfigChangeDemoServer3.java](file://demos/src/main/java/com/github/dtprj/dongting/demos/configchange/ConfigChangeDemoServer3.java)
- [ConfigChangeDemoServer4.java](file://demos/src/main/java/com/github/dtprj/dongting/demos/configchange/ConfigChangeDemoServer4.java)

**章节来源**
- [ConfigChangeDemoServer1.java](file://demos/src/main/java/com/github/dtprj/dongting/demos/configchange/ConfigChangeDemoServer1.java)
- [ConfigChangeDemoServer2.java](file://demos/src/main/java/com/github/dtprj/dongting/demos/configchange/ConfigChangeDemoServer2.java)
- [ConfigChangeDemoServer3.java](file://demos/src/main/java/com/github/dtprj/dongting/demos/configchange/ConfigChangeDemoServer3.java)
- [ConfigChangeDemoServer4.java](file://demos/src/main/java/com/github/dtprj/dongting/demos/configchange/ConfigChangeDemoServer4.java)

### 客户端分析
配置变更客户端包含两个实现：ChangeTo123Client和ChangeTo234Client。这两个客户端用于执行相反的配置变更操作，分别将集群成员从[2,3,4]变更为[1,2,3]和从[1,2,3]变更为[2,3,4]。

```mermaid
sequenceDiagram
participant Client as "ChangeTo123Client"
participant Admin as "AdminRaftClient"
participant Leader as "Leader Node"
participant Follower as "Follower Node"
Client->>Admin : start()
Client->>Admin : clientAddNode(servers)
Client->>Admin : clientAddOrUpdateGroup(GROUP_ID, nodes)
Admin->>Leader : fetchLeader(GROUP_ID)
Leader-->>Admin : 返回Leader信息
Admin-->>Client : 获取Leader成功
Client->>Admin : prepareConfigChange()
Admin->>Leader : 发送RAFT_ADMIN_PREPARE_CHANGE
Leader->>Follower : 广播配置变更准备
Follower-->>Leader : 返回投票结果
Leader-->>Admin : 返回prepareIndex
Admin-->>Client : 准备成功
Client->>Admin : commitChange(prepareIndex)
Admin->>Leader : 发送RAFT_ADMIN_COMMIT_CHANGE
Leader->>Follower : 广播配置变更提交
Follower-->>Leader : 返回确认
Leader-->>Admin : 返回提交结果
Admin-->>Client : 提交成功
```

**图示来源**
- [ChangeTo123Client.java](file://demos/src/main/java/com/github/dtprj/dongting/demos/configchange/ChangeTo123Client.java)
- [ChangeTo234Client.java](file://demos/src/main/java/com/github/dtprj/dongting/demos/configchange/ChangeTo234Client.java)
- [AdminRaftClient.java](file://server/src/main/java/com/github/dtprj/dongting/raft/admin/AdminRaftClient.java)
- [AdminConfigChangeProcessor.java](file://server/src/main/java/com/github/dtprj/dongting/raft/rpc/AdminConfigChangeProcessor.java)

**章节来源**
- [ChangeTo123Client.java](file://demos/src/main/java/com/github/dtprj/dongting/demos/configchange/ChangeTo123Client.java)
- [ChangeTo234Client.java](file://demos/src/main/java/com/github/dtprj/dongting/demos/configchange/ChangeTo234Client.java)

### 配置变更机制分析
配置变更机制基于RAFT算法的Joint Consensus两阶段提交协议实现。该机制通过prepare和commit两个阶段确保配置变更的安全性，避免出现脑裂问题。

```mermaid
flowchart TD
Start([开始配置变更]) --> CheckCurrentStatus["检查当前成员状态"]
CheckCurrentStatus --> IsTargetConfig{"目标配置已生效?"}
IsTargetConfig --> |是| ExitSuccess["退出: 配置已生效"]
IsTargetConfig --> |否| CheckLeader["检查Leader节点"]
CheckLeader --> IsLeaderNeedTransfer{"需要转移Leader?"}
IsLeaderNeedTransfer --> |是| TransferLeader["转移Leader"]
IsLeaderNeedTransfer --> |否| PrepareConfig["准备配置变更"]
TransferLeader --> PrepareConfig
PrepareConfig --> SendPrepare["发送RAFT_ADMIN_PREPARE_CHANGE"]
SendPrepare --> WaitQuorum["等待多数派确认"]
WaitQuorum --> GetPrepareIndex["获取prepareIndex"]
GetPrepareIndex --> CommitConfig["提交配置变更"]
CommitConfig --> SendCommit["发送RAFT_ADMIN_COMMIT_CHANGE"]
SendCommit --> WaitCommitQuorum["等待多数派确认"]
WaitCommitQuorum --> UpdateConfig["更新集群配置"]
UpdateConfig --> VerifyConfig["验证配置一致性"]
VerifyConfig --> ExitSuccess
```

**图示来源**
- [AdminRaftClient.java](file://server/src/main/java/com/github/dtprj/dongting/raft/admin/AdminRaftClient.java)
- [RaftGroupImpl.java](file://server/src/main/java/com/github/dtprj/dongting/raft/impl/RaftGroupImpl.java)
- [MemberManager.java](file://server/src/main/java/com/github/dtprj/dongting/raft/impl/MemberManager.java)

**章节来源**
- [AdminRaftClient.java](file://server/src/main/java/com/github/dtprj/dongting/raft/admin/AdminRaftClient.java)
- [RaftGroupImpl.java](file://server/src/main/java/com/github/dtprj/dongting/raft/impl/RaftGroupImpl.java)
- [MemberManager.java](file://server/src/main/java/com/github/dtprj/dongting/raft/impl/MemberManager.java)

## 依赖分析
配置变更示例的组件依赖关系清晰，客户端依赖于AdminRaftClient进行管理操作，服务器节点依赖于基础的DemoKvServerBase实现。核心的配置变更逻辑由RaftGroup和MemberManager实现。

```mermaid
graph TD
subgraph "客户端依赖"
C1[ChangeTo123Client] --> AR[AdminRaftClient]
C2[ChangeTo234Client] --> AR
AR --> RC[RaftClient]
RC --> NC[NioClient]
end
subgraph "服务器依赖"
S1[ConfigChangeDemoServer1] --> DK[DemoKvServerBase]
S2[ConfigChangeDemoServer2] --> DK
S3[ConfigChangeDemoServer3] --> DK
S4[ConfigChangeDemoServer4] --> DK
DK --> RS[RaftServer]
RS --> RG[RaftGroupImpl]
RG --> MM[MemberManager]
MM --> NM[NodeManager]
end
AR --> S2
AR --> S3
AR --> S4
```

**图示来源**
- [ChangeTo123Client.java](file://demos/src/main/java/com/github/dtprj/dongting/demos/configchange/ChangeTo123Client.java)
- [ChangeTo234Client.java](file://demos/src/main/java/com/github/dtprj/dongting/demos/configchange/ChangeTo234Client.java)
- [AdminRaftClient.java](file://server/src/main/java/com/github/dtprj/dongting/raft/admin/AdminRaftClient.java)
- [ConfigChangeDemoServer1.java](file://demos/src/main/java/com/github/dtprj/dongting/demos/configchange/ConfigChangeDemoServer1.java)
- [ConfigChangeDemoServer2.java](file://demos/src/main/java/com/github/dtprj/dongting/demos/configchange/ConfigChangeDemoServer2.java)
- [ConfigChangeDemoServer3.java](file://demos/src/main/java/com/github/dtprj/dongting/demos/configchange/ConfigChangeDemoServer3.java)
- [ConfigChangeDemoServer4.java](file://demos/src/main/java/com/github/dtprj/dongting/demos/configchange/ConfigChangeDemoServer4.java)

**章节来源**
- [ChangeTo123Client.java](file://demos/src/main/java/com/github/dtprj/dongting/demos/configchange/ChangeTo123Client.java)
- [ChangeTo234Client.java](file://demos/src/main/java/com/github/dtprj/dongting/demos/configchange/ChangeTo234Client.java)
- [ConfigChangeDemoServer1.java](file://demos/src/main/java/com/github/dtprj/dongting/demos/configchange/ConfigChangeDemoServer1.java)
- [ConfigChangeDemoServer2.java](file://demos/src/main/java/com/github/dtprj/dongting/demos/configchange/ConfigChangeDemoServer2.java)
- [ConfigChangeDemoServer3.java](file://demos/src/main/java/com/github/dtprj/dongting/demos/configchange/ConfigChangeDemoServer3.java)
- [ConfigChangeDemoServer4.java](file://demos/src/main/java/com/github/dtprj/dongting/demos/configchange/ConfigChangeDemoServer4.java)

## 性能考虑
配置变更操作涉及集群的重新配置，会对系统性能产生一定影响。在prepare阶段，新旧配置的节点都会参与选举和日志复制的多数派计算，可能导致短暂的性能下降。建议在系统负载较低时执行配置变更操作，并确保网络稳定性。

## 故障排除指南
配置变更过程中可能遇到的常见问题包括：Leader节点不可用、网络分区、配置变更超时等。可以通过查询集群状态来诊断问题，使用queryRaftServerStatus方法获取当前集群的成员信息和Leader状态。

**章节来源**
- [ChangeTo123Client.java](file://demos/src/main/java/com/github/dtprj/dongting/demos/configchange/ChangeTo123Client.java)
- [ChangeTo234Client.java](file://demos/src/main/java/com/github/dtprj/dongting/demos/configchange/ChangeTo234Client.java)
- [ConfigChangeTest.java](file://server/src/test/java/com/github/dtprj/dongting/raft/server/ConfigChangeTest.java)

## 结论
配置变更示例展示了RAFT算法中成员变更的完整实现过程，通过两阶段提交协议确保了变更的安全性。该示例从三节点到四节点再回退的完整配置演进过程，验证了系统在动态变更场景下的稳定性和一致性。用户可以通过此示例深入理解RAFT算法中成员变更的复杂性及其实现细节。